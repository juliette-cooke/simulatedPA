---
title: "simPA_paper_generic"
output: html_document
date: "2024-07-22"
---

# Setup
## Libraries
```{r libraries}
library(dplyr)
library(tibble)
library(ggplot2)
library(stringr)
library(ggraph)
library(ggrepel)
library(ggnewscale)
library(igraph)
library(pals)
library(cowplot)
library(tidyr)
library(ggpubr)
library(forcats)
library(jsonlite)
library(ggh4x)
library(patchwork)
# PCA
library(FactoMineR)
library(factoextra)
```

## Set variables
Use the model name that is in the exported files.
Make a folder and add the path here, with a slash at the end.
```{r}
# model_name = "Recon2.2"
model_name = "Human1"
input.path = paste0("../../data/output/",model_name,"/")
# input.path = "../../data/output/"
# Set to T if using the same categories as in the pathways_db file, aka Human1 categories (used for the colour palette):
human.pathway.categories = T 
exch.metab.pattern = "e" # or "_e" for example
# exch.metab.pattern = "_e" # or "_e" for example
# Change these to suit your tested methods
methods.indexes = seq(1:3)
names(methods.indexes) = c("ORA", "GSEA abs", "GSEA raw")
```


## Read in data
```{r data}
# Data exported from python:
# List of all metabolites and their respective pathway
pathways = read.table(paste0(input.path,"metabolite_pathways.tsv"), sep="\t", header=T) %>% unique()
# Pathway dictionary of each pathway Human1 ID and name
pathway_dict = read.table(paste0(input.path,"pathway_dict.tsv"), sep = "\t", header=T)

# Pathway states (unable to KO, blocked, unable to ORA)
pathway.states = read.table(paste0(input.path,"pathway_states.tsv"), sep="\t", header=T)

metabolites = read.table(paste0(input.path,"metab_dict.tsv"), sep="\t", header=T,quote = "") 

# List of pathways which were unable to run because of KO infeasibility since we are using a default WT
# infeasible_pathways_ko = read.table(paste0(input.path,"infeasible_pathways.txt"), sep="\t") %>% pull(V1)
infeasible_pathways_ko = pathway.states %>% filter(Type == "infeasible") %>% pull(Pathway)

# Input data from ORA and GSEA, with a default WT for ALL pathways
# These are the output filenames from python
filenames = c(paste0(model_name,"_",list("ORA_pval_005_metrics_external", "GSEA_absolute_metric_external","GSEA_raw_metric_external"),"_with_WT_default_all"))


# Categorised pathways: this file needs to be created by hand...
pathway_categories = read.table(paste0(input.path,"pathway_db.tsv"), sep="\t", header = T)

# List of Miscellaneous pathways which are removed from the analysis
# Either a file you wrote yourself (i), or extracted from the pathway categories (ii).
# (i)
#misc_blocked_pathways = read.table(paste0(input.path,"miscellaneous_pathways.txt"), sep="\t") %>% pull(V1)
# (ii)
misc_pathways = pathway_categories %>% filter(ManualCategoryLvl1 == "Miscellaneous") %>% pull(Pathway)
blocked_pathways = pathway.states %>% filter(Type == "blocked") %>% pull(Pathway)
misc_blocked_pathways = c(misc_pathways, blocked_pathways) %>% unique()
```

## Colour scheme
```{r}
basic_colour = "#56B4E9" # Used for plots where there are no other colours

# Read pathway category colours if possible:
if (human.pathway.categories){
  pathway_cat_cols = read.table("../../data/output/Human1_pathway_category_colours.tsv", sep="\t", header=T, comment.char = "")
}else{
  # Otherwise generate a new palette:
  max_n = length(unique(pathway_categories$ManualCategoryLvl1))+4
  cols = glasbey()[5:max_n]
  pathway_cat_cols = pathway_categories %>% select(ManualCategoryLvl1) %>%
    unique() %>%
    mutate("col" = cols)
}

types_names = c("FN", "TP", "Infeasible", "Feasible", "Not run", 
                "Unable to be run in ORA", "Unable to produce biomass when KO'd", "Blocked")

colours = c("#FF0000", "#3660d6","#c40d00", "#1a57ba", "#5c5c5c", "#808080", "lightgrey","#808080")
dark_colours = c("#a80000", "#2d4ba1","#800800", "#203b8a", "#5c5c5c", "#5c5c5c","#5c5c5c","#808080")

# Base colours
pathway_cat_cols_dict = append(colours , paste0(pathway_cat_cols$col,"B3"))
names(pathway_cat_cols_dict) = append(types_names, pathway_cat_cols$ManualCategoryLvl1)

# Base colours with alpha (necessary for lighter colours in circle plots)
pathway_cat_cols_dict_light = append(colours, paste0(pathway_cat_cols$col,"66"))
names(pathway_cat_cols_dict_light) = append(types_names, pathway_cat_cols$ManualCategoryLvl1)

# Darker colours (necessary for darker outlines in circle plots)
pathway_cat_cols_line_dict = append(dark_colours , paste0(pathway_cat_cols$col, "FF"))
names(pathway_cat_cols_line_dict) = append(types_names,pathway_cat_cols$ManualCategoryLvl1)

# Add "Cat_" to the beginning of category names to avoid duplicate names with certain pathways
cat_pathway_cat_cols_dict_light = pathway_cat_cols_dict_light
names(cat_pathway_cat_cols_dict_light) = append(types_names, paste0("Cat_", pathway_cat_cols$ManualCategoryLvl1))
cat_pathway_cat_cols_line_dict = pathway_cat_cols_line_dict
names(cat_pathway_cat_cols_line_dict) = append(types_names, paste0("Cat_",pathway_cat_cols$ManualCategoryLvl1))
```


```{r}
# Read in metrics files
method_names = filenames %>% unlist()
# if (model_name=="Human1"){
#   pathways.to.exclude = c("Triacylglycerol synthesis")
# }
# methods_to_test = lapply(filenames, function(x){
#   if (model_name=="Human1"){
#     # Manually remove a pathway that was not used in GSEA for Human1
#     read.table(paste0(input.path,x,".csv"), sep = ",", header = T) %>% 
#       filter(!Subsystem.name %in% pathways.to.exclude)
#   }else{
#     read.table(paste0(input.path,x,".csv"), sep = ",", header = T) 
#   }
# })
methods_to_test = lapply(filenames, function(x){
  read.table(paste0(input.path,x,".csv"), sep = ",", header = T)
})
names(methods_to_test) = method_names

# Compile all files into one list object while converting data into a usable format
all_methods_TP_FN = lapply(methods_to_test, function(x){
  x %>%
  mutate(Type = ifelse(TPR==1,"TP", ifelse(FNR==1,"FN",""))) %>%
  filter(!Subsystem.name %in% misc_blocked_pathways) %>%
  left_join(pathway_categories, by = c("Subsystem.name" = "Pathway")) %>%
  select(Subsystem.name, ManualCategoryLvl1, Type)
})
names(all_methods_TP_FN) = filenames

pathways_to_exclude = pathway_categories$Pathway[(!pathway_categories$Pathway %in% all_methods_TP_FN[[methods.indexes[["GSEA abs"]]]]$Subsystem.name) & (!pathway_categories$Pathway %in% infeasible_pathways_ko)]

# infeasible_pathways_df = infeasible_pathways %>% as.data.frame() %>% rename("Subsystem.name" = 1) %>%
#   left_join(pathway_categories %>% select(Pathway, ManualCategoryLvl1), by=c("Subsystem.name" = "Pathway"))

all_methods_TP_FN_cat = lapply(methods_to_test, function(x){
  not.run = methods_to_test[[methods.indexes["GSEA abs"]]]$Subsystem.name[!(methods_to_test[[methods.indexes["GSEA abs"]]]$Subsystem.name %in% x$Subsystem.name)] %>% as.data.frame() %>% 
    rename("Subsystem.name" =1) %>% 
    mutate(Type = "Unable to be run in ORA", FPR=NA, TNR=NA) %>% 
    filter(!Subsystem.name %in% x$Subsystem.name)
  
  # wt_infeas = infeasible_pathways_wt %>% as.data.frame() %>% 
  #   rename("Subsystem.name" =1) %>% 
  #   mutate(Type = "Unable to produce biomass in WT", FPR=NA, TNR=NA) %>% 
  #   filter(!Subsystem.name %in% x$Subsystem.name) %>% 
  #   filter(!Subsystem.name %in% not.run$Subsystem.name)
  blocked = blocked_pathways %>% as.data.frame() %>% 
    rename("Subsystem.name" =1) %>% 
    mutate(Type = "Blocked", FPR=NA, TNR=NA)
  
  if ("TNR2" %in% colnames(x)){
    x = x %>% select(-TNR) %>% 
      rename(TNR = TNR2)
  }
  
  x %>%
    mutate(Type = ifelse(TPR==1,"TP", ifelse(FNR==1,"FN", ""))) %>%
    filter(!Subsystem.name %in% misc_blocked_pathways) %>%
    select(Subsystem.name, Type, FPR, TNR) %>% 
    rbind(infeasible_pathways_ko %>% as.data.frame() %>% rename("Subsystem.name" =1) %>% mutate(Type = "Unable to produce biomass when KO'd", FPR=NA, TNR=NA)) %>% 
    # rbind(wt_infeas) %>% 
    rbind(not.run) %>% 
    rbind(blocked) %>% 
    filter(!Subsystem.name %in% misc_blocked_pathways) %>%
    left_join(pathway_categories %>% select(Pathway, ManualCategoryLvl1), by = c("Subsystem.name" = "Pathway")) %>%
    mutate(ManualCategoryLvl1 = paste0("Cat_", ManualCategoryLvl1))
})

# Prepare feasibility categories
all_pathway_cat_feas_infeas = pathway_categories %>% select(Pathway, ManualCategoryLvl1)  %>%
  mutate(Type = ifelse(Pathway %in% infeasible_pathways_ko, "Infeasible", 
                       ifelse(Pathway %in% misc_blocked_pathways, "Not run", "Feasible"))) %>%
  mutate(ManualCategoryLvl1 = paste0("Cat_",ManualCategoryLvl1)) %>% 
  filter(!Pathway %in% misc_blocked_pathways)

all_pathway_feas_infeas = pathway_categories %>% select(Pathway, ManualCategoryLvl1)  %>%
  mutate(Type = ifelse(Pathway %in% infeasible_pathways_ko, "Infeasible", 
                       ifelse(Pathway %in% misc_pathways, "Not run", 
                              ifelse(Pathway %in% blocked_pathways, "Blocked", "Feasible")))) %>% 
  filter(Type != "Not run")%>% 
  filter(!Pathway %in% misc_blocked_pathways)

label_dict_no_misc = c("Feasible", "Infeasible")
names(label_dict_no_misc) = c("Able to produce biomass when KO'd", "Unable to produce biomass when KO'd")

label_dict_no_misc_swap = c("Able to produce biomass when KO'd", "Unable to produce biomass when KO'd", "All pathways", "Blocked pathways")
names(label_dict_no_misc_swap) = c("Feasible", "Infeasible", "All","Blocked")

# Read in raw ORA and GSEA results
raw_method_results = lapply(paste0(filenames, "_results"), function(x){
    read.table(paste0(input.path,x,".tsv"), sep="\t", header=T)
})
names(raw_method_results) = method_names

```

# Pathway stats
## Pathway sizes
These pathway sizes are not the same as in the default model: they do not count metabolites removed by deleting blocked reactions.
```{r}
pathway_sizes = pathways %>% group_by(subsystem) %>% summarise(size = n()) %>% rename("Pathway" = "subsystem") %>% 
  left_join(pathway_categories %>% select(Pathway, ManualCategoryLvl1), by = c("Pathway"))
pathway_sizes_inf_fea = all_pathway_feas_infeas %>% left_join(pathway_sizes, by = c("Pathway", "ManualCategoryLvl1")) %>%  rbind(pathway_sizes %>% mutate(Type = "All"))

# Colour dict
pathway_type_dict = append(pathway_cat_cols_dict[c("Infeasible", "Feasible")], basic_colour)
names(pathway_type_dict) = c("Infeasible", "Feasible", "All")

pathway_sizes_inf_fea_no_misc = pathway_sizes_inf_fea %>% 
  filter(ManualCategoryLvl1 != "Miscellaneous") 

binwidth=10
max_counts = max(hist(pathway_sizes_inf_fea_no_misc %>% filter(Type=="All") %>% pull(size), plot=F, 
                    breaks=seq(0, max(pathway_sizes_inf_fea_no_misc %>% filter(Type=="All") %>% pull(size))+21,by=binwidth))$counts)

pathway_sizes_plot =
  pathway_sizes_inf_fea_no_misc %>% 
  # filter(Type == "All") %>% 
  ggplot()+
  geom_histogram(aes(x=size, fill=Type), binwidth = binwidth)+
  facet_wrap(~Type, nrow = 3, labeller = as_labeller(label_dict_no_misc_swap))+
  theme_minimal()+
  ylab("N. of pathways")+
  xlab("Pathway size")+
  theme(strip.background = element_blank(), legend.position = "None", axis.title = element_text(size=9))+
  scale_fill_manual(values =pathway_type_dict[pathway_sizes_inf_fea$Type])+
  geom_text(data = pathway_sizes_inf_fea %>% 
  filter(ManualCategoryLvl1 != "Miscellaneous") %>% 
              group_by(Type) %>%
              slice(1) %>%ungroup() %>% 
              mutate(TypeNum = row_number(), label = LETTERS[as.numeric(TypeNum)]),
            aes(label = label, x = -45, y = max_counts*1.15), color = "black", fontface = "bold", size=5)+
    coord_cartesian(clip="off", ylim = c(0,max_counts), xlim= c(0, max(pathway_sizes_inf_fea_no_misc$size)))
pathway_sizes_plot
```

## Pathway feasible/infeasible counts per category
```{r}
category_sizes = pathway_categories %>% select(Pathway, ManualCategoryLvl1) %>% group_by(ManualCategoryLvl1) %>% summarise(n = n()) %>% arrange(n)

all_pathway_feas_infeas$ManualCategoryLvl1 = factor(all_pathway_feas_infeas$ManualCategoryLvl1, levels = category_sizes$ManualCategoryLvl1)
all_pathway_feas_infeas_blocked = all_pathway_feas_infeas %>% rbind(pathway_categories %>% filter(Pathway %in% blocked_pathways) %>% select(Pathway, ManualCategoryLvl1) %>% mutate("Type" = "Blocked"))

pathway_stats_feas_plot =
  all_pathway_feas_infeas_blocked %>%
    mutate(Type = fct_relevel(Type, c("Blocked","Feasible", "Infeasible"))) %>% 
  ggplot()+
  geom_bar(aes(y = ManualCategoryLvl1, fill = Type), position="stack")+
  theme_minimal()+
  scale_fill_manual(values=pathway_cat_cols_dict[all_pathway_feas_infeas_blocked$Type], 
                    labels = label_dict_no_misc_swap[all_pathway_feas_infeas_blocked$Type], name = "")+
  theme(axis.title = element_text(size=9),
        axis.text.y = element_text(size=9, margin = margin(r=0)),
        legend.position = "bottom",
        # legend.box="vertical", 
        # legend.position.inside = c(-20,1),
        legend.location = "plot",
     legend.justification='left',
     legend.box = "horizontal",
     # legend.margin = margin(0),
     # legend.key = element_blank(),
     legend.direction = "horizontal",
     plot.margin = margin(0.5,0.5,0.2,0.5,"cm"))+
  guides(fill = guide_legend(nrow = 2))+
  xlab("N. of pathways")+
  ylab("")+ 
  scale_x_continuous(expand = c(0, 0))+
  scale_y_discrete(labels=label_wrap_gen(25))

pathway_stats_feas_plot
#ggsave("../../plots/stacked_barplot_r2.png", width = 8, height = 5, dpi = 300, bg = "white")
```

## Fig1
```{r}
plot_grid(
  plot_grid(NULL,pathway_sizes_plot, NULL, nrow=1, rel_widths = c(0,1,0)), 
  pathway_stats_feas_plot, labels=c("","D"), rel_widths = c(0.4,0.6), nrow=1)
ggsave(paste0("../../plots/Fig1_",model_name,"-2.png"),bg="white", dpi=300, width = 11, height = 5.5)
```

# Fig2
```{r}
categories_to_pathways = lapply(all_methods_TP_FN_cat, function(x){
  x %>%
  rename("from" = ManualCategoryLvl1, "to" = Subsystem.name) %>%
  relocate(from)
})

g_all = lapply(categories_to_pathways, function(x){
  g = graph_from_data_frame(x)
  g_temp = create_layout(g, 'circlepack')
  list(g, g_temp)
})

pathways_to_TP_FN = lapply(seq_along(all_methods_TP_FN_cat), function(i){
  all_methods_TP_FN_cat[[i]] %>%
  select(-ManualCategoryLvl1) %>%
  rename("Pathway" = Subsystem.name) %>%
  rbind(all_methods_TP_FN_cat[[i]] %>% select(ManualCategoryLvl1) %>% 
  unique() %>% mutate("Type" = "NA", "FPR" = "NA", "TNR" = "NA") %>% rename("Pathway" = ManualCategoryLvl1)) %>%
  arrange(match(Pathway, g_all[[i]]$g_temp$name))
})

pathway_counts = lapply(pathways_to_TP_FN, function(x){
  pathways %>% group_by(subsystem) %>%
  count() %>% rename("Pathway" = subsystem) %>%
  mutate("Name" = "subsystem") %>%
  rbind(pathway_categories%>% group_by(ManualCategoryLvl1) %>% select(Pathway, ManualCategoryLvl1) %>%
  count() %>% rename("Pathway" = ManualCategoryLvl1) %>% mutate("Name" = "category", Pathway=paste0("Cat_", Pathway))) %>%
  mutate(Name = ifelse(Name=="category", Pathway, NA)) %>%
  left_join(x %>% mutate(Name = ifelse(is.na(Type), "category", NA)), by = c("Pathway", "Name"))
})
labelled_categories = lapply(all_methods_TP_FN_cat, function(x){
  x %>% group_by(ManualCategoryLvl1) %>% 
    # count() %>%
    mutate(n = n()) %>% 
  filter(ManualCategoryLvl1 %in% paste0("Cat_",pathway_cat_cols$ManualCategoryLvl1) & (Type=="FN" |n ==1) ) %>%
  pull(ManualCategoryLvl1)
})
pathway_counts_run = lapply(seq_along(pathways_to_TP_FN), function(i){
  pathway_counts[[i]] %>% filter(Pathway %in% pathways_to_TP_FN[[i]]$Pathway) %>%
  rename("name" = Pathway) %>%
  mutate(Type = ifelse(is.na(Type), str_remove(name, "Cat_"), Type), label = ifelse(name %in% labelled_categories[[i]], str_remove(Name, "Cat_"), NA),
         linetype=ifelse(Type=="Unable to produce biomass when KO'd", 2, 
                         ifelse(Type=="Unable to produce biomass in WT",2,1)))
})

linetype_dict = ifelse(unique(pathway_counts_run[[1]]$Type) %in% 
                         c("Unable to produce biomass when KO'd", "Unable to produce biomass in WT"), 3, 1)
names(linetype_dict) = unique(pathway_counts_run[[1]]$Type)

g = lapply(seq_along(categories_to_pathways), function(i){
  graph_from_data_frame(categories_to_pathways[[i]], vertices=pathway_counts_run[[i]])
})
layout = lapply(g, function(x){
  create_layout(x, 'circlepack', weight = n) %>% 
    mutate(r = ifelse(is.na(Name), r-0.2, r))
})
```

## GSEA raw
Run GSEA plots first to get the coordinates for all other circle plots
```{r}
base_layout = methods.indexes["GSEA raw"]
if (model_name == "Human1"){
  layout_coord = read.table("../../data/output/circlepack_layout.tsv", sep="\t", header=T,quote = "")
  i = methods.indexes["GSEA raw"]
  layout[[i]]=layout[[i]] %>% select(-x,-y,-r) %>% left_join(layout_coord %>% select(name,x,y,r), by="name")
}else{
  i = methods.indexes["GSEA raw"]
}
```


```{r}
# all_circle_plots = lapply(seq_along(layout), function(i){
  main_plot =
    ggraph(layout[[i]]%>% arrange(Type))+
    geom_node_circle(aes(fill=Type, color=Type, group=leaf, linetype=as.factor(Type)))+
    theme_void()+
    scale_fill_manual(values = pathway_cat_cols_dict_light[pathway_counts_run[[i]]$Type],na.value = "white")+
    scale_color_manual(values = pathway_cat_cols_line_dict[pathway_counts_run[[i]]$Type])+
    scale_linetype_manual(values=linetype_dict[pathway_counts_run[[i]]$Type])+
    coord_equal(clip='off')+
    theme(legend.position = "none")+
    ggraph::geom_node_label(aes(label=str_wrap(label,23)),alpha=0.6,lineheight = 0.7, size=3)

TP_FN_legend =
    layout[[i]] %>% filter(Type %in% c("TP", "FN", "Unable to produce biomass when KO'd")) %>%
    mutate(Type = fct_relevel(Type, c("TP", "FN","Unable to produce biomass when KO'd"))) %>% ggraph()+
    geom_node_circle(aes(fill=Type, group=depth, color=Type, linetype=as.factor(Type)))+
    scale_fill_manual(values = pathway_cat_cols_dict_light[pathway_counts_run[[i]]$Type],na.value = "white", name="Predicted",
                      labels=c("True Positive", "False Negative", 
                               "Unable to produce biomass when KO'd"))+
    scale_color_manual(values = pathway_cat_cols_line_dict[pathway_counts_run[[i]]$Type], name="Predicted",
                      labels=c("True Positive", "False Negative", 
                               "Unable to produce biomass when KO'd"))+
  scale_linetype_manual(values=linetype_dict[pathway_counts_run[[i]]$Type], 
                        labels=c("True Positive", "False Negative", 
                               "Unable to produce biomass when KO'd"), name="Predicted")+
    theme(legend.margin = margin(c(-0.5,0,0,0)))


cat_legend = layout[[i]] %>% filter(!Type %in% c("TP", "FN", "Unable to produce biomass when KO'd")) %>% ggraph()+
    geom_node_circle(aes(fill=Type, group=depth, color=Type))+
    scale_fill_manual(values = pathway_cat_cols_dict_light[pathway_counts_run[[i]]$Type],na.value = "white", name="Pathway category")+
    scale_color_manual(values = pathway_cat_cols_line_dict[pathway_counts_run[[i]]$Type], name="Pathway category")+
    theme(legend.margin = margin(c(-0.5,0,0,0)))
  
  p2 = plot_grid(
    main_plot,
    plot_grid(get_legend(TP_FN_legend),
    get_legend(cat_legend),nrow = 2, align = "hv", rel_heights = c(0.3,0.7))
    ,nrow = 1, rel_widths = c(0.6,0.4))
  p2
  
  GSEA_raw_no_leg = main_plot
```

## GSEA abs
Match circle coords from GSEA raw
```{r}
i=methods.indexes["GSEA abs"]
GSEA_abs_layout = layout[[i]] %>% select(-x,-y, -r) %>% left_join(layout[[base_layout]] %>% select(x, y,r, name), by="name")
#write.table(GSEA_abs_layout, "../../data/output/circlepack_layout.tsv", sep="\t", quote = F, row.names = F)

  main_plot =
    ggraph(GSEA_abs_layout %>% arrange(Type))+
    geom_node_circle(aes(fill=Type, color=Type, group=leaf, linetype=as.factor(Type)))+
    theme_void()+
    scale_fill_manual(values = pathway_cat_cols_dict_light[pathway_counts_run[[i]]$Type],na.value = "white")+
    scale_color_manual(values = pathway_cat_cols_line_dict[pathway_counts_run[[i]]$Type])+
    scale_linetype_manual(values=linetype_dict[pathway_counts_run[[i]]$Type])+
    coord_equal(clip='off')+
    theme(legend.position = "none")+
    ggraph::geom_node_label(aes(label=str_wrap(label,23)),alpha=0.6,lineheight = 0.7, size=3)

TP_FN_legend = layout[[i]] %>% filter(Type %in% c("TP", "FN", "Unable to produce biomass when KO'd")) %>%
    mutate(Type = fct_relevel(Type, c("TP", "FN", "Unable to produce biomass when KO'd"))) %>% ggraph()+
    geom_node_circle(aes(fill=Type, group=depth, color=Type, linetype=as.factor(Type)))+
    scale_fill_manual(values = pathway_cat_cols_dict_light[pathway_counts_run[[i]]$Type],na.value = "white", name="Predicted",
                      labels=c("True Positive", "False Negative", 
                               "Unable to produce biomass when KO'd",
                               "Unable to produce biomass in WT"
                               ))+
    scale_color_manual(values = pathway_cat_cols_line_dict[pathway_counts_run[[i]]$Type], name="Predicted",
                      labels=c("True Positive", "False Negative", 
                               "Unable to produce biomass when KO'd",
                               "Unable to produce biomass in WT"))+
  scale_linetype_manual(values=linetype_dict[pathway_counts_run[[i]]$Type], 
                        labels=c("True Positive", "False Negative", 
                               "Unable to produce biomass when KO'd",
                               "Unable to produce biomass in WT"
                               ), name="Predicted")+
    theme(legend.margin = margin(c(-0.5,0,0,0)))
    
  cat_legend = layout[[i]] %>% filter(!Type %in% c("TP", "FN", "Unable to produce biomass when KO'd")) %>% ggraph()+
    geom_node_circle(aes(fill=Type, group=depth, color=Type))+
    scale_fill_manual(values = pathway_cat_cols_dict_light[pathway_counts_run[[i]]$Type],na.value = "white", name="Pathway category")+
    scale_color_manual(values = pathway_cat_cols_line_dict[pathway_counts_run[[i]]$Type], name="Pathway category")+
    theme(legend.margin = margin(c(-0.5,0,0,0)))
  
  p3 = plot_grid(
    main_plot,
    plot_grid(get_legend(TP_FN_legend),
    get_legend(cat_legend),nrow = 2, align = "hv", rel_heights = c(0.3,0.7))
    ,nrow = 1, rel_widths = c(0.6,0.4))
  p3
  GSEA_abs_no_leg = main_plot
```
## ORA

```{r}
i=methods.indexes["ORA"]
ORA_layout = layout[[i]] %>% select(-x,-y, -r) %>% left_join(layout[[base_layout]] %>% select(x, y,r, name), by="name")

# all_circle_plots = lapply(seq_along(layout), function(i){
  main_plot =
    ggraph(ORA_layout%>% arrange(Type))+
    geom_node_circle(aes(fill=Type, color=Type, group=leaf, linetype=as.factor(Type)))+
    theme_void()+
    scale_fill_manual(values = pathway_cat_cols_dict_light[pathway_counts_run[[i]]$Type],na.value = "white")+
    scale_color_manual(values = pathway_cat_cols_line_dict[pathway_counts_run[[i]]$Type])+
    scale_linetype_manual(values=linetype_dict[pathway_counts_run[[i]]$Type])+
    coord_equal(clip='off')+
    theme(legend.position = "none")+
    ggraph::geom_node_label(aes(label=str_wrap(label,23)),alpha=0.6,lineheight = 0.7, size=3)

TP_FN_legend =
    layout[[i]] %>% filter(Type %in% c("TP", "FN", "Unable to be run in ORA", "Unable to produce biomass when KO'd", "TP_WT_default", "FN_WT_default")) %>% mutate(Type = fct_relevel(Type, c("TP", "FN", "Unable to be run in ORA", "Unable to produce biomass when KO'd"))) %>% ggraph()+
    geom_node_circle(aes(fill=Type, group=depth, color=Type, linetype=as.factor(Type)))+
    scale_fill_manual(values = pathway_cat_cols_dict_light[pathway_counts_run[[i]]$Type],na.value = "white", name="Predicted",
                      labels=str_wrap(c("True Positive", "False Negative", 
                               "Unable to be run in ORA",
                               "Unable to produce biomass when KO'd"
                               ), 23))+
    scale_color_manual(values = pathway_cat_cols_line_dict[pathway_counts_run[[i]]$Type], name="Predicted",
                      labels=str_wrap(c("True Positive", "False Negative",  
                               "Unable to be run in ORA",
                               "Unable to produce biomass when KO'd"), 23))+
  scale_linetype_manual(values=linetype_dict[pathway_counts_run[[i]]$Type], 
                        labels=str_wrap(c("True Positive", "False Negative", 
                               "Unable to be run in ORA",
                               "Unable to produce biomass when KO'd"
                               ), 23), name="Predicted")

cat_legend = layout[[i]] %>% filter(!Type %in% c("TP", "FN", "Unable to be run in ORA", "Unable to produce biomass when KO'd")) %>% ggraph()+
    geom_node_circle(aes(fill=Type, group=depth, color=Type))+
    scale_fill_manual(values = pathway_cat_cols_dict_light[pathway_counts_run[[i]]$Type],na.value = "lightgrey", name="Pathway category")+
    scale_color_manual(values = pathway_cat_cols_line_dict[pathway_counts_run[[i]]$Type], name="Pathway category")#+
    # theme(legend.margin = margin(c(0,0,0,0)))
  
  p1 = plot_grid(
    main_plot,
    plot_grid(get_legend(TP_FN_legend),
    get_legend(cat_legend),nrow = 2, align = "hv", rel_heights = c(0.3,0.7))
    ,nrow = 1, rel_widths = c(0.6,0.4))
  p1
  ORA_no_leg = main_plot
  
# })
```

## Fig2
### Legend
Made manually, can need adjusting visually
```{r}
if (model_name == "Recon2.2"){
  circle_div = 18
}else{
  circle_div = 25
}

max_size = max(layout[[1]]$n)
min_size = min(layout[[1]]$n)
scale_legend =
  layout[[1]] %>% 
  ggplot()+
  geom_point(aes(size=n), x=1, y=1, pch=21, fill="white", color="#3b3b3b")+
  scale_size_continuous(breaks =c(min_size,100,max_size), name="Pathway size", range=c(3,max_size/circle_div))+
  theme_minimal()
  # theme(legend.direction = "horizontal", legend.title.position = "top")

circle_legend =
  plot_grid(plot_grid(
    get_legend(TP_FN_legend),
    NULL,
    get_legend(scale_legend), 
    nrow=3, align="hv", rel_heights = c(0.48,0.005,0.48)),
    
    get_legend(cat_legend),
    
    nrow = 1, align = "v")+theme(plot.margin = margin(0,2,0,0, "cm"))
#cat_legend+theme(plot.margin = margin(0.5,1,0.5,0.5, "cm"))
```

```{r}
plot_grid(ORA_no_leg, circle_legend, NULL,NULL, GSEA_abs_no_leg, GSEA_raw_no_leg,  labels = c("A","","","","B","C"), nrow=3, rel_heights = c(0.45,0.03,0.45),
          hjust=c(-0.5,0,0,0,-0.3,-0.3))

ggsave(paste0("../../plots/Fig2_",model_name,".png"), bg="white", width=11, height = 10, dpi=300)
#ggsave("../../plots/Fig2-2-no-bg.png", width=11, height = 10, dpi=300)
```


# Fig3
## Barplot
```{r}
all_methods_TP_FN_long = lapply(c(1:3), function(i){
  all_methods_TP_FN_cat[[i]] %>% mutate(method = method_names[i])
})
all_methods_df = do.call(rbind, all_methods_TP_FN_long)

all_methods_df_FPR_TNR = all_methods_df %>% pivot_longer(c(FPR, TNR)) %>% select(-Type) %>% group_by(method, name) %>% 
  summarise(value = mean(value, na.rm=T)) %>% mutate(group=2) %>% rename("Type" = name) %>% 
  ungroup() %>% 
  mutate(method = fct_relevel(method,method_names))

TP_FN_plot =
  all_methods_df %>% 
  filter(!Type %in% c("Unable to produce biomass when KO'd", "Unable to produce biomass in WT")) %>% 
  group_by(method, Type) %>% 
  summarise(n = n()) %>% 
  mutate(total = sum(n), value = n/total) %>% 
  ungroup() %>% 
  mutate(Type = fct_relevel(Type, c("Unable to be run in ORA","FN",
                                    # "FN_WT_default", 
                                    "TP"
                                    # "TP_WT_default"
                                    )),
         method = fct_relevel(method, paste0(model_name, "_",c("ORA_pval_005_metrics_external", "GSEA_absolute_metric_external", "GSEA_raw_metric_external"), "_with_WT_default_all"
                                             )),
         group=1) %>% 
  select(method, Type, value, group) %>% 
  ggplot(aes(x=method, y= value, fill=Type))+
  geom_bar(stat="identity", col="white")+
  geom_text(aes(label=round(value,2)), position = position_stack(vjust=0.5), col="white", size=4)+
  theme_minimal_hgrid()+
  scale_fill_manual(values = pathway_cat_cols_dict[all_methods_df$Type], 
                    labels=c("Unable to be\nrun in ORA","FN",
                             # "FN (default WT)", 
                             "TP"
                             # "TP (default WT)"
                             ))+
  scale_x_discrete(labels = c("ORA", "GSEA\nabs", "GSEA\nraw"))+
  xlab("")+
  ylab("Proportion")+
  theme(axis.line.x = element_blank(), axis.ticks.x = element_blank(),
        legend.position = "right", legend.justification = "center",
        legend.direction = "vertical", legend.title = element_blank())

FPR_TNR_colours = c("#ed978c", "#8a82ed")
names(FPR_TNR_colours) = c("FPR", "TNR")

FPR_TNR_plot = all_methods_df_FPR_TNR %>% 
ggplot(aes(x=method, y= value, fill=Type))+
  geom_bar(stat="identity", col="white")+
  geom_text(aes(label=round(value,2)), position = position_stack(vjust=0.5), col="white", size=4)+
  theme_minimal_hgrid()+
  scale_fill_manual(values = FPR_TNR_colours[all_methods_df_FPR_TNR$Type], labels=c("FP", "TN"))+
  scale_x_discrete(labels = c("ORA", "GSEA\nabs", "GSEA\nraw"))+
  xlab("")+
  ylab("Counts")+
  theme(axis.line.x = element_blank(), axis.ticks.x = element_blank(),
        legend.position = "right", legend.justification = "center",
        legend.direction = "vertical", legend.title = element_blank())

ggarrange(TP_FN_plot, FPR_TNR_plot, widths = c(0.55,0.45), labels = "AUTO", align="h")
```
## Z-scores
```{r}
zthr=50
zscores.kod.pathways = pathways_no_comp2 %>% 
  left_join(z.scores.long, by = c("Pathway", "metabolite" = "metabID")) %>% 
  filter(!is.na(value)) %>% 
  # group_by(Pathway) %>% 
  # summarise(value = mean(value)) %>%
  left_join(all_methods_TP_FN_long_df %>% 
              mutate(Method = str_replace_all(Method, method_names_clean))%>% 
              filter(Method == "GSEA abs"), 
            by = c("Pathway")) %>% 
  group_by(Pathway) %>% 
  reframe(sd =sd(value), metabolite, Pathway, value, Type) %>% 
  arrange(sd) %>% 
  mutate(Pathway = fct_inorder(Pathway)) %>% 
  mutate(value = ifelse(value >= zthr, zthr, 
                        ifelse(value <= -zthr, -zthr, value)))


zscores.kod.pathways %>% 
  filter(value >= zthr | value <= -zthr) 
# 6 metabolites modified for plotting purposes

zscores.plot = zscores.kod.pathways %>%
  ggplot(aes(y=(value), x= Pathway, col=Type))+
  geom_boxplot(outliers=T,outlier.alpha = 0.2)+
  scale_colour_manual(values = pathway_cat_cols_dict[zscores.kod.pathways$Type], name = "GSEA abs\nprediction")+
  theme_minimal()+
  theme(axis.text.x = element_blank())+
  xlab("KO'd pathways (sorted by std)")+
  ylab("KO'd pathway's\nmetabolite z-scores")+
  guides(col=guide_legend(reverse=TRUE))
zscores.plot
```


```{r}

zscores.all.df = z.scores.long %>% 
  left_join(all_methods_TP_FN_long_df %>% 
              mutate(Method = str_replace_all(Method, method_names_clean))%>% 
              filter(Method == "GSEA abs"), 
            by = c("Pathway")) %>% 
  rename("KOd.pathway" = "Pathway") %>% 
  left_join(pathways_no_comp2 %>% filter(!Pathway %in% misc_blocked_pathways), by = c("metabID" = "metabolite")) %>% 
  filter(!metabID %in% side_compounds$Identifier) %>% 
  # filter(KOd.pathway == "Lysine metabolism") %>% 
  group_by(KOd.pathway) %>%
  mutate(KOd.p.metab = ifelse(KOd.pathway == Pathway, T, F)) %>% 
  select(-Pathway) %>%
  unique() %>%
  group_by(KOd.pathway, metabID) %>% 
  filter(!any(KOd.p.metab)) %>% 
  # left_join(zscores.kod.pathways %>% select(Pathway, sd) %>% unique(), by = c("KOd.pathway" = "Pathway"))%>% 
  # arrange(sd) %>% 
  mutate(KOd.pathway = factor(KOd.pathway, levels = zscores.kod.pathways %>% pull(Pathway) %>% unique()))
  # arrange(factor(KOd.pathway, zscores.kod.pathways %>% pull(Pathway) %>% unique())) %>% 
  # mutate(KOd.pathway = fct_inorder(KOd.pathway)) #%>% 
  # filter(!is.na(Type))

  zscores.all.df$KOd.pathway

TNR.for.barplot = TNR.counts %>% 
  mutate(unique_id = factor(unique_id, levels = zscores.kod.pathways %>% pull(Pathway) %>% unique())) %>% 
  filter(!is.na(unique_id)) %>% 
  rename("KOd.pathway" = "unique_id")
  
FP_TN_colours = FPR_TNR_colours
names(FP_TN_colours) = c("FP", "TN")

# zscores.all.df.plot =
zscores.all.df.all = zscores.all.df %>%
    filter(!is.na(Type)) %>% 
  left_join(TNR.counts %>%
  mutate(unique_id = factor(unique_id, levels = zscores.kod.pathways %>% pull(Pathway) %>% unique())) %>%
  filter(!is.na(unique_id)),
  by = c("KOd.pathway" = "unique_id")) %>% 
  group_by(KOd.pathway) %>% 
  reframe(sd =sd(value), metabID, KOd.pathway, value, Type, TNR, counts) %>% 
  arrange(sd) %>% 
  mutate(KOd.pathway = fct_inorder(KOd.pathway)) 

zscores.all.df.plot=zscores.all.df.all %>%
  ggplot()+
  geom_bar( aes(x=KOd.pathway, y=counts/6, fill=TNR),stat="unique", inherit.aes = F, alpha=0.8)+
    scale_y_continuous(sec.axis=sec_axis(~.*6,breaks = c(0,40,80,120), name = "Ratio of TN/FP pathways"))+
  geom_boxplot(aes(y=value, x= KOd.pathway, col=Type), outliers=T,outlier.alpha = 0.2, inherit.aes = F)+
  scale_colour_manual(values = pathway_cat_cols_dict[zscores.all.df.all$Type], name = "GSEA abs\nprediction")+
    scale_fill_manual(values = FP_TN_colours[zscores.all.df.all$TNR], name = "GSEA abs\n TN / FP")+
  theme_minimal()+
  theme(axis.text.x = element_blank())+
    # theme(axis.text.x = element_text(angle = 45))+
  xlab("KO'd pathways (sorted by std)")+
  ylab("Metabolite z-scores\n(without the KO'd pathway's metabolites)")+
  guides(col=guide_legend(reverse=TRUE))
zscores.all.df.plot

ggsave(paste0("../../plots/test.png"), dpi=300, bg="white", width=11, height=7)
```

```{r}
TNR.counts %>% 
  mutate(Term = factor(Term, levels = zscores.kod.pathways %>% pull(Pathway) %>% unique())) %>% 
  filter(!is.na(Term)) %>% 
  ggplot(aes(x=Term, y=counts, fill=TNR))+
  geom_bar(stat="identity")+
   theme(axis.text.x = element_blank())
```


```{r}
# ggsave(paste0("../../plots/exchangeable_metabs_WT_default_all_",model_name,"_3.png"), width = 12, height = 10, bg= "white")
```

## Fig3
```{r}
plot_grid(plot_grid(TP_FN_plot, NULL,FPR_TNR_plot, rel_widths = c(0.5,0.05,0.5), 
                    ncol = 3, labels=c("A","B")),
  nrow=2,
  zscores.plot,
  labels = c("", "C"), rel_heights = c(0.33,0.33, 0.33))
ggsave(paste0("../../plots/Fig3_", model_name,".png"), dpi=300, bg="white", width=10, height=7)
```

## Fig3 with all
```{r}
plot_grid(plot_grid(TP_FN_plot, NULL,FPR_TNR_plot, rel_widths = c(0.5,0.05,0.5), 
                    ncol = 3, labels=c("A","B")),
  nrow=3,
  zscores.plot, 
  zscores.all.df.plot,
  labels = c("", "C", "D"), rel_heights = c(0.33,0.33, 0.33))
ggsave(paste0("../../plots/Fig3_", model_name,"_all.png"), dpi=300, bg="white", width=11, height=12)
```


```{r}
# plot_grid(plot_grid(plot_grid(NULL,TP_FN_plot,NULL, FPR_TNR_plot,NULL, rel_widths = c(0.1,0.4,0.2,0.4,0.1), 
#                     ncol = 5, labels=c("A","","","B","")),
#   upset.plot.all,
#   labels = c("","D"), 
#   nrow=2),exch_plot, labels = c("", "C"), rel_widths = c(0.4,0.6))
# ggsave("../../plots/Fig3_Human1_2.png", dpi=300, bg="white", width=15, height=8)
```


# Fig4
## Exchangeable metabolites ratio
Exchangeable metabolites ratio is defined by:
n. of exchangeable metabolites (not counting side compounds)
/
n. of total metabolites in the pathways (counting side compounds)

This penalises side compounds as even if they are exchangeable, they do not add information to the metabolic profile. 
(most of the time)
```{r}
length.to.strip = str_length(exch.metab.pattern)+1

side_compounds = read.table(paste0(input.path,"side_compounds.txt"), header = T) %>% 
  rename("Identifier"=1) %>% 
  mutate(Identifier = stringr::str_sub(Identifier, end=-str_length(exch.metab.pattern)-1)) %>% unique() %>% 
  mutate(Identifier = ifelse(startsWith(Identifier, "M_"), str_sub(Identifier, start=3), Identifier))

exchange_metabolites = pathways %>% filter(endsWith(metabolite, exch.metab.pattern)) %>% 
  mutate(metabolite = str_sub(metabolite, end = -length.to.strip)) %>% 
  filter(!(metabolite %in% (side_compounds %>%
           mutate(Identifier = str_remove(Identifier, pattern="^M_")) %>%
           pull(Identifier)))) %>%
  pull(metabolite) %>% unique()
  

exchangeable_metabolites_per_pathway = pathways %>% 
  mutate(metabolite = str_sub(metabolite, end = -length.to.strip)) %>% group_by(subsystem) %>% 
  filter(metabolite %in% exchange_metabolites) %>% unique() %>% summarise(Exchangeable = length(metabolite)) %>% 
  left_join(pathways %>% group_by(subsystem) %>% summarise(Total=length(metabolite)), by = "subsystem") %>% 
  mutate(ExchangeableRatio = Exchangeable/Total) 

if (exists("pathways.to.exclude")){
  exchangeable_metabolites_per_pathway = exchangeable_metabolites_per_pathway %>%
  filter(!subsystem %in% pathways.to.exclude)
}

for (i in 1:length(all_methods_TP_FN)){
  exchangeable_metabolites_per_pathway = exchangeable_metabolites_per_pathway %>% 
    left_join(all_methods_TP_FN[[i]] %>% select(Subsystem.name, Type) %>% rename(!!filenames[[i]] := "Type"), by = c("subsystem" = "Subsystem.name"))
}

exchangeable_m_filtered = exchangeable_metabolites_per_pathway %>% 
  left_join(pathway_categories %>% select(Pathway, ManualCategoryLvl1), by = c("subsystem" = "Pathway")) %>% 
  filter(!subsystem %in% misc_blocked_pathways)

exchangeable_m_filtered$subsystem = factor(exchangeable_m_filtered$subsystem, levels=exchangeable_m_filtered %>% arrange(ExchangeableRatio) %>% pull(subsystem))

exchangeable_m_filtered = exchangeable_m_filtered %>% 
  pivot_longer(!!method_names) 
exchangeable_m_filtered$name = factor(exchangeable_m_filtered$name, levels=method_names)

exchangeable_m_filtered = exchangeable_m_filtered %>% 
  filter(!subsystem %in% infeasible_pathways_ko) %>% 
  mutate(value = ifelse(startsWith(as.character(name), "ORA") & is.na(value),"Unable to be run in ORA", value)) %>% 
  filter(Total >= 3)

# Exchangeable Ratio bar plot
ex_ratio_plot =
  exchangeable_m_filtered %>% 
  filter(endsWith(as.character(name), "all")) %>% 
  select(subsystem, ExchangeableRatio) %>% unique() %>% 
  ggplot()+
  geom_bar(aes(x=ExchangeableRatio, y = subsystem), stat = "identity", fill = basic_colour)+
  theme_minimal()+
    theme(axis.text.y = element_text(size=7))+
  ylab("")+
  xlab("Exchangeable metabolites ratio")

method_names_clean = setNames(c("ORA", "GSEA abs","GSEA raw"), method_names)
exchangeable_m_filtered_clean = exchangeable_m_filtered %>% 
  filter(endsWith(as.character(name), "all"))%>% 
    mutate(name=str_replace_all(name, method_names_clean))
exchangeable_m_filtered_clean$name = factor(exchangeable_m_filtered_clean$name, levels = method_names_clean)

# TP and FN heatmap
ex_TP_FN_plot =
  exchangeable_m_filtered_clean %>% 
    mutate(name = fct_relevel(name, c("ORA", "GSEA abs","GSEA raw"))) %>%
    ggplot()+
      geom_tile(aes(x=name, y= subsystem, fill = value), colour = "white", linewidth = 0.7)+
      scale_fill_manual(values = pathway_cat_cols_dict[exchangeable_m_filtered_clean$value], na.value = "lightgrey")+
      scale_x_discrete(position="top")+
      theme_minimal()+
      theme(axis.text.y = element_blank(),
            axis.title = element_blank(), 
            axis.ticks = element_blank(),
            legend.position = "none", 
            axis.text.x = element_text(angle=45, hjust = 0.1, vjust = 0),
            panel.grid = element_blank())

# TP and FN legend
ex_TP_FN_plot_legend =
  exchangeable_m_filtered %>% 
  mutate(value = fct_relevel(value, c("TP", "FN", "Unable to be run in ORA"))) %>%
  ggplot()+
  geom_tile(aes(x=name, y= subsystem, fill = value))+
  scale_fill_manual(values = pathway_cat_cols_dict[exchangeable_m_filtered_clean$value], name="Predicted", na.value = "lightgrey",
                    labels=c("True Positive", "False Negative", "Unable to be run in ORA", "Unable to produce biomass when KO'd"))+
  theme_void()+
  theme(axis.text = element_blank(), axis.title = element_blank(), axis.ticks = element_blank())

# Pathway category plot
ex_category_plot =
  exchangeable_m_filtered %>% 
  select(subsystem, ManualCategoryLvl1) %>% 
    mutate("label" = "Pathway\ncategory") %>% 
  ggplot()+
  geom_tile(aes(x = label, y= subsystem, fill = ManualCategoryLvl1), linewidth = 0.7, colour = "white")+
  scale_fill_manual(values = pathway_cat_cols_dict[exchangeable_m_filtered$ManualCategoryLvl1])+
    scale_x_discrete(position="top")+
  theme_minimal()+
  theme(axis.text.y = element_blank(), axis.title = element_blank(), axis.ticks = element_blank(),
        legend.position = "none",
        axis.text.x = element_text(angle=45, hjust = 0.1, vjust = 0), panel.grid = element_blank())

# Pathway category plot legend
ex_category_plot_legend =
  exchangeable_m_filtered %>% 
  select(subsystem, ManualCategoryLvl1) %>% 
  ggplot()+
  geom_tile(aes(x=1, y= subsystem, fill = ManualCategoryLvl1))+
  scale_fill_manual(values = pathway_cat_cols_dict[exchangeable_m_filtered$ManualCategoryLvl1], name = "Pathway category")+
  theme_void()+
  theme(axis.text = element_blank(), axis.title = element_blank(), axis.ticks = element_blank())+
  guides(fill = guide_legend(override.aes = list(alpha = 1))) 

# Join all the plots together
exch_plot = plot_grid(
  plot_grid(
    ex_ratio_plot,
    ex_category_plot,
    ex_TP_FN_plot,
    rel_widths = c(0.85,0.1,0.1), nrow = 1, align = 'h'),
  plot_grid(NULL,
    get_legend(ex_TP_FN_plot_legend),
    get_legend(ex_category_plot_legend),
    NULL,
      rel_heights = c(0.25,0.25,0.25,0.25),
      align = 'hv',
      nrow = 4, ncol = 1),
rel_widths = c(0.7, 0.3), nrow = 1)
exch_plot
```
## Fig4
```{r}
plot_grid(exch_plot)#, 
          # labels = c("","", "C"), 
          # rel_widths = c(0.2,0.05,0.8))
ggsave(paste0("../../plots/Fig4_", model_name,".png"), dpi=300, bg="white", width=15, height=12)
```


# Fig5

```{r}
network_stats = read.table(paste0("../../data/input/",model_name,"_no_blocked_cytoscape_pathway_graph_statistics.csv"), sep = ",", header = T)
GSEA.abs.results = read.table(paste0(input.path,model_name,"_GSEA_absolute_metric_external_with_WT_default_all_results.tsv"), sep="\t", header=T)
if (model_name == "Human1"){
  z.scores = read.table('../../data/large/zscores_WT_default_all.tsv', sep="\t", header=T) %>%
  filter(Metab %in% metabolites$ID)
}else if (model_name == "Recon2.2"){
  z.scores = read.table("/home/juliette/work/pipelines/simpa/Recon2.2/zscores.tsv", sep='\t', header=T)
}
```

## Uniqueness
```{r}
# z.scores = read.table('../../data/large/zscores.tsv', sep="\t", header=T) %>% 
  # filter(Metab %in% metabolites$ID)
thr=2
# z.scores %>% pivot_longer(-Metab) %>% 
#   left_join(pathway_dict, by = c("name" = "Group")) %>% select(-name) %>% 
#   group_by(Metab) %>% 
#   reframe(zscores = (value - mean(value)) / sd(value), Pathway) %>% 
#   group_by(Metab) %>% 
#   summarise(m = summary(zscores))
uniqueness = z.scores %>% pivot_longer(-Metab) %>% 
  left_join(pathway_dict, by = c("name" = "Group")) %>% select(-name) %>% 
  rename("zscores" = value) %>% 
  group_by(Metab) %>% 
  # reframe(zscores = (value - mean(value)) / sd(value), Pathway) %>% 
  filter(zscores > thr | zscores < -thr) %>% 
  left_join(metabolites %>% select(-metabID), by = c("Metab" = "ID")) %>% 
  select("Pathway","Name","zscores") %>% #pull(Pathway) %>% table() %>% sort(decreasing = T)
  # mutate(direction = ifelse(zscores > 0, "pos", "neg")) %>% 
  group_by(Name) %>% 
  summarise(n=n(), Pathway) %>% #pull(n) %>% table() %>% sort(decreasing = T)
  group_by(Pathway) %>% 
  mutate(score = sum(1/n), n.metab = sum(n()), unique = sum(n==1), unique_score = unique/n.metab) %>% 
  select(-Name, -n) %>% 
  unique() %>% 
  arrange(desc(score))

all_methods_TP_FN_long = lapply(names(all_methods_TP_FN), function(x){
  all_methods_TP_FN[[x]] %>% select(-ManualCategoryLvl1) %>% 
    mutate(Method = x)
  })
all_methods_TP_FN_long_df = all_methods_TP_FN_long %>% bind_rows() %>% rename("Pathway" = Subsystem.name)

metab.uniqueness = all_methods_TP_FN_long_df %>% left_join(uniqueness, by="Pathway") %>% 
  left_join(exchangeable_m_filtered ,#%>% 
              # filter(name == paste0(model_name,"_GSEA_absolute_metric_external_with_WT_default_all"))
              by = c("Pathway" = "subsystem")) %>%
  select(-name, -Exchangeable, -value) %>% 
  # filter(unique<100) %>%
  pivot_longer(-c(Pathway, Type, ManualCategoryLvl1, Method)) %>% 
  filter(!is.na(value)) 

newnames <- data.frame(name = c("Total","ExchangeableRatio","score","n.metab","unique","unique_score"),
                      name_label = c("Pathway size", "Exchangeable Ratio", "Profile uniqueness score",
                                     "N. of significant metabs", "N. of significant unique metabs",
                                     "N. of significant unique metabs / \nN. of significant metabs"))

metab.uniqueness.plot = metab.uniqueness %>% 
  inner_join(newnames, by="name") %>% 
  mutate(name_label = fct_inorder(name_label),
         Method = str_replace_all(Method, method_names_clean)) %>% 
  unite(Type, Method, col="TypeMethod", sep= ": ",remove = F) %>% 
  mutate(TypeMethod = fct_relevel(TypeMethod, rev(c("TP: ORA", "FN: ORA", "TP: GSEA abs", "FN: GSEA abs", "TP: GSEA raw", "FN: GSEA raw")))) %>% unique()

metab.uniqueness.plot %>%
  ggplot(aes(x=value, y=TypeMethod, col=Type, group=TypeMethod, fill=Type))+
  geom_boxplot(outliers = F, alpha=0.4)+
  facet_wrap(~name_label, scales = "free",strip.position = "bottom")+
  theme_minimal()+
  scale_fill_manual(values = pathway_cat_cols_dict[metab.uniqueness.plot$Type])+
  scale_colour_manual(values = pathway_cat_cols_dict[metab.uniqueness.plot$Type])+
  xlab("")
  # scale_x_continuous(transform = "log")

```

```{r}
variables = c("Pathway size", "Exchangeable Ratio", "Profile uniqueness score")
pathway_metrics_plot=
  metab.uniqueness.plot %>%
  filter(name_label %in% variables) %>% 
  mutate(Type = fct_relevel(Type, c("TP", "FN")),
         name_label = fct_relevel(name_label, variables),
         Method = fct_relevel(Method,method_names_clean)) %>% 
  ggplot(aes(x=value, col=Type, fill=Type, y=Type))+
  geom_boxplot(outliers = F, alpha=0.4)+
  facet_nested(Method + Type ~name_label, scales = "free",
               strip = strip_nested(size = "variable"),switch = "y")+
  theme_minimal()+
  theme(strip.text.y.left = element_text(angle = 0,size = 8),
        axis.text.y = element_blank(),
        panel.spacing.x = unit(1, "lines"),
        legend.position = "none")+
  scale_fill_manual(values = pathway_cat_cols_dict[metab.uniqueness.plot$Type])+
  scale_colour_manual(values = pathway_cat_cols_dict[metab.uniqueness.plot$Type])+
  xlab("")+
  ylab("")
pathway_metrics_plot
#ggsave(paste0("../../plots/Fig4_",model_name,".png"), bg="white", dpi=300, width = 9, height=5)

```

## PCA
```{r}
z.scores.long = z.scores %>% pivot_longer(-Metab) %>% 
  left_join(pathway_dict, by = c("name" = "Group")) %>% select(-name) %>% 
  left_join(metabolites, by = c("Metab" = "ID"))

pathways_no_comp2 = pathways %>% mutate(metabolite = stringr::str_sub(metabolite, end=-length.to.strip)) %>% unique() %>% 
  rename("Pathway" = subsystem)

mean.zscores = 
  all_methods_TP_FN_long_df %>% 
  filter(Method == paste0(model_name,"_GSEA_absolute_metric_external_with_WT_default_all")) %>% 
  select(Pathway, Type)  %>% 
  left_join(pathways_no_comp2, by = c("Pathway")) %>% 
  left_join(z.scores.long , by = c("Pathway", "metabolite" = "metabID")) %>% 
  filter(!is.na(value)) %>% group_by(Pathway) %>% 
  summarise(mean = mean(abs(value)), Type) %>% unique() 

non.uniques = data.frame("Pathway" = exchangeable_metabolites_per_pathway$subsystem[!exchangeable_metabolites_per_pathway$subsystem %in% uniqueness$Pathway],
           "score"= 0, "n.metab" = 0, "unique" = 0, "unique_score" = 0)


GSEA.NES = GSEA.abs.results %>% 
  # filter(Term == unique_id & NOM.p.val > 0.05) %>% 
  filter(Term == unique_id) %>% 
  select(Term, NES)

pca.data = exchangeable_metabolites_per_pathway %>% filter(!(subsystem %in% misc_pathways)) %>% 
  left_join(uniqueness %>% rbind(non.uniques), by = c("subsystem"= "Pathway")) %>% 
  left_join(mean.zscores, by = c("subsystem"= "Pathway")) %>% 
  rename("GSEA.abs" = paste0(model_name, "_GSEA_absolute_metric_external_with_WT_default_all"),
         "ProfileUniquenessScore" = score, "PathwaySize" = Total) %>% 
  select(subsystem, GSEA.abs, ProfileUniquenessScore, ExchangeableRatio, PathwaySize) %>% 
  left_join(network_stats %>% select(name, AverageShortestPathLength, BetweennessCentrality, ClosenessCentrality, ClusteringCoefficient, Degree, NeighborhoodConnectivity, Stress, TopologicalCoefficient), by = c("subsystem" = "name")) %>% 
  filter(!is.na(GSEA.abs))%>%
  # filter(!subsystem %in% c("Peptide metabolism", "Vitamin B2 metabolism", "Riboflavin metabolism"))%>%
  # select(-c(Stress,BetweennessCentrality,AverageShortestPathLength, Degree,NeighborhoodConnectivity, TopologicalCoefficient, score))# %>%

  mutate(ProfileUniquenessScore = ifelse(is.na(ProfileUniquenessScore), 0, ProfileUniquenessScore)) %>% 
  left_join(GSEA.NES, by = c("subsystem" = "Term")) %>% 
  mutate(NES = ifelse(GSEA.abs == "FN" & is.na(NES), -1.5, NES))%>% 
  filter(Degree != 0) %>%
    select(-c(AverageShortestPathLength ,  Stress, ClosenessCentrality,TopologicalCoefficient,BetweennessCentrality))%>%
  # Recon2.2:
    # select(-c(Stress, Degree,score, AverageShortestPathLength, Total, TopologicalCoefficient, NeighborhoodConnectivity))
  filter(PathwaySize > 5) %>%
  mutate(NES = ifelse(NES <0, min(abs(NES)), NES)) 


indiv = pca.data %>% select(-GSEA.abs, -NES) %>% 
  tibble::column_to_rownames("subsystem")

groups = pca.data %>% column_to_rownames("subsystem") %>% select(GSEA.abs, NES)

res.PCA = PCA(indiv,scale.unit = T) 

arrow_coord = fviz_pca_biplot(res.PCA)$layers[[6]]$data
# Radial shift function
rshift = function(r, theta, a=0.1, b=0.7) {
  r + a + b*abs(cos(theta))
}

# Calculate shift
arrow_coord = arrow_coord %>% 
  mutate(r = sqrt(x^2 + y^2),
         theta = atan2(y,x),
         rnew = rshift(r, theta),
         xnew = rnew*cos(theta),
         ynew = rnew*sin(theta))

pca.coord = res.PCA$ind$coord %>% as.data.frame() %>% 
  rownames_to_column("subsystem") %>% 
  left_join(pathway_categories %>% select(Pathway, ManualCategoryLvl1), by = c("subsystem" = "Pathway"))

pca_biplot =
  pca.coord %>% 
  ggplot(aes(x=Dim.1, y=Dim.2))+
  geom_segment(data = arrow_coord, aes(xend=x,yend=y, x=xstart,y=ystart), inherit.aes = F, arrow = arrow(length = unit(0.2, "cm")))+
  geom_point(aes(shape=factor(groups$GSEA.abs), 
                 fill=factor(groups$GSEA.abs)), size = 3, alpha=0.8)+
  scale_shape_manual(values = c(23,21), name = "GSEA prediction")+
  scale_fill_manual(values = pathway_cat_cols_dict[groups$GSEA.abs], name = "GSEA prediction")+
  scale_colour_manual(values = pathway_cat_cols_dict[groups$GSEA.abs], name = "GSEA prediction")+
  stat_ellipse(aes(col=factor(groups$GSEA.abs)))+
  coord_cartesian(clip="off")+
  theme_minimal()+
  theme(legend.position = "bottom",
          legend.title =element_text(margin=margin(0,20,0,0)),
          axis.title.y = element_text(hjust = 0.4),
        plot.margin = margin(0.4,0.2,0.2,0.7, "cm"))+
  geom_hline(yintercept = 0, linetype="dashed")+
  geom_vline(xintercept = 0, linetype="dashed")+
  xlab(paste0("Dim1 ", "(",  round(res.PCA$eig["comp 1", "percentage of variance"],1),"%)"))+
  ylab(paste0("Dim2 ", "(",  round(res.PCA$eig["comp 2", "percentage of variance"],1),"%)"))+
  geom_label(data = arrow_coord, 
             aes(x=xnew,y=ynew, label = str_wrap(str_replace_all(name,"(.)(?=[A-Z])", "\\1 "),50)), 
             inherit.aes = F,
             fill=alpha(c("white"), 0.5))
pca_biplot
```

### PCA: pathway categories
```{r}
pca_biplot_cat =
  pca.coord %>% 
    ggplot(aes(x=Dim.1, y=Dim.2))+
    geom_segment(data = arrow_coord, aes(xend=x,yend=y, x=xstart,y=ystart), inherit.aes = F, arrow = arrow(length = unit(0.2, "cm")))+
    geom_point(aes(shape=factor(groups$GSEA.abs), 
                   # fill=factor(groups$GSEA.abs), 
                   fill = ManualCategoryLvl1), size = 3, alpha=0.8)+
    scale_shape_manual(values = c(23,21), name = "GSEA abs prediction")+
    # scale_fill_manual(values = pathway_cat_cols_dict[groups$GSEA.abs], name = "GSEA abs prediction")+
    scale_fill_manual(values = pathway_cat_cols_dict[pca.coord$ManualCategoryLvl1], name = "Pathway category",
                      labels = function(x) str_wrap(x, width = 15))+
    scale_colour_manual(values = pathway_cat_cols_dict[groups$GSEA.abs], name = "GSEA abs prediction")+
    stat_ellipse(aes(col=factor(groups$GSEA.abs)))+
    coord_cartesian(clip="off")+
    theme_minimal()+
    theme(legend.position = "right",
            legend.title =element_text(margin=margin(b=10)),
            axis.title.y = element_text(hjust = 0.4),
          plot.margin = margin(0.4,0.55,0.4,0.7, "cm"),
          legend.key.spacing.y = unit(0.25,"cm"))+
    geom_hline(yintercept = 0, linetype="dashed")+
    geom_vline(xintercept = 0, linetype="dashed")+
    xlab(paste0("Dim1 ", "(",  round(res.PCA$eig["comp 1", "percentage of variance"],1),"%)"))+
    ylab(paste0("Dim2 ", "(",  round(res.PCA$eig["comp 2", "percentage of variance"],1),"%)"))+
    geom_label(data = arrow_coord, 
               aes(x=xnew,y=ynew, label = str_wrap(str_replace_all(name,"(.)(?=[A-Z])", "\\1 "),50)), 
               inherit.aes = F,
               fill=alpha(c("white"), 0.5))+
    guides(fill = guide_legend(override.aes = list(shape=21, size=4)), 
           colour="none", 
           shape="none")
pca_biplot_cat
```


## Fig5 
```{r}
pathway_graph = ggdraw() + draw_image(paste0("../../plots/",model_name,"_pathway_graph_edited.png"))
fig4 = plot_grid(plot_grid(pathway_metrics_plot,pathway_graph, nrow=2, rel_heights = c(0.35,0.65), labels = c("A","B")), 
                 plot_grid(NULL, pca_biplot, NULL, nrow=3, labels = c("","C",""), rel_heights = c(0.2,0.6,0.2)), nrow=1, rel_widths = c(0.45,0.55))
ggsave(plot=fig4, paste0("../../plots/Fig5_", model_name,".png"), dpi=300, bg="white", width = 15, height=10)
```